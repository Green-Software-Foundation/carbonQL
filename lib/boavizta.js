"use strict";
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BoaviztaCpuImpactModel = exports.BoaviztaCloudImpactModel = exports.BoaviztaCpuParams = exports.camelToSnake = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const axios_1 = require("axios");
const camelToSnake = (str) => str.replace(/([A-Z])/g, ($1) => `_${$1.toLowerCase()}`);
exports.camelToSnake = camelToSnake;
class BoaviztaCpuParams {
}
exports.BoaviztaCpuParams = BoaviztaCpuParams;
_a = JSII_RTTI_SYMBOL_1;
BoaviztaCpuParams[_a] = { fqn: "carbonql.BoaviztaCpuParams", version: "1.0.0" };
class BoaviztaCloudImpactModel {
    constructor() {
        this.authCredentials = undefined;
    }
    modelIdentifier() {
        return "boavizta.cloud.sci";
    }
    configure(name, staticParams) {
        const staticParamCast = staticParams;
        if (staticParamCast?.hasOwnProperty('provider')) {
            this.provider = staticParamCast.provider;
        }
        this.name = name;
        return this;
    }
    configureTyped(name, staticParamCast) {
        if (staticParamCast?.hasOwnProperty('provider')) {
            this.provider = staticParamCast.provider;
        }
        this.name = name;
        return this;
    }
    authenticate(authParams) {
        this.authCredentials = authParams;
    }
    async usage(data) {
        const dataCast = data;
        if ('provider' in dataCast) {
            if (this.provider !== undefined) {
                dataCast.provider = this.provider;
            }
            else {
                throw new Error('Malformed Telemetry: Missing provider');
            }
        }
        if ('instance_type' in dataCast) {
            throw new Error('Malformed Telemetry: Missing instance_type');
        }
        const response = await axios_1.default.post('https://api.boavizta.org/v1/cloud/', dataCast);
        return response.data;
    }
}
exports.BoaviztaCloudImpactModel = BoaviztaCloudImpactModel;
_b = JSII_RTTI_SYMBOL_1;
BoaviztaCloudImpactModel[_b] = { fqn: "carbonql.BoaviztaCloudImpactModel", version: "1.0.0" };
class BoaviztaCpuImpactModel {
    constructor() {
        this.componentType = "cpu";
        this.verbose = false;
        this.allocation = "TOTAL";
        this.authCredentials = undefined;
    }
    modelIdentifier() {
        return "boavizta.cpu.sci";
    }
    authenticate(authParams) {
        this.authCredentials = authParams;
    }
    configure(name, staticParams) {
        const staticParamCast = this.captureStaticParams(staticParams);
        this.name = name;
        this.sharedParams = staticParamCast;
        return this;
    }
    captureStaticParams(staticParamCast) {
        if ('verbose' in staticParamCast) {
            this.verbose = staticParamCast.verbose ?? false;
            staticParamCast.verbose = undefined;
        }
        if ('allocation' in staticParamCast) {
            this.allocation = staticParamCast.allocation ?? "total";
            staticParamCast.allocation = undefined;
        }
        return staticParamCast;
    }
    configureTyped(name, staticParamCast) {
        staticParamCast = this.captureStaticParams(staticParamCast);
        this.name = name;
        this.sharedParams = staticParamCast;
        return this;
    }
    async usage(data) {
        const usageCast = data;
        let mTotal = 0;
        let eTotal = 0;
        if (Array.isArray(usageCast)) {
            for (const usage of usageCast) {
                const { m, e } = await this.singleUsage(usage);
                mTotal += m;
                eTotal += e;
            }
        }
        else {
            const { m, e } = await this.singleUsage(usageCast);
            mTotal += m;
            eTotal += e;
        }
        return {
            "e": eTotal,
            "m": mTotal
        };
    }
    async singleUsage(usageCast) {
        if (this.sharedParams === undefined) {
            throw new Error("Improper Initialization: Missing configuration parameters");
        }
        const dataCast = this.normalizeData(this.sharedParams);
        dataCast['usage'] = usageCast;
        const response = await axios_1.default.post(`https://api.boavizta.org/v1/component/${this.componentType}?verbose=${this.verbose}&allocation=${this.allocation}`, dataCast);
        return this.formatResponse(response);
    }
    normalizeData(dataParams) {
        const dataCast = Object.assign(dataParams);
        for (let key in dataCast) {
            dataCast[(0, exports.camelToSnake)(key)] = dataCast[key];
            if (/[A-Z]/.test(key)) {
                delete dataCast[key];
            }
        }
        return dataCast;
    }
    formatResponse(response) {
        let m = 0;
        let e = 0;
        if ('impacts' in response.data) {
            m = response.data['impacts']['gwp']['manufacture'] * 1000;
            e = response.data['impacts']['pe']['use'] / 3.6;
        }
        else if ('gwp' in response.data && 'pe' in response.data) {
            m = response.data['gwp']['manufacture'] * 1000;
            e = response.data['pe']['use'] / 3.6;
        }
        return { m, e };
    }
}
exports.BoaviztaCpuImpactModel = BoaviztaCpuImpactModel;
_c = JSII_RTTI_SYMBOL_1;
BoaviztaCpuImpactModel[_c] = { fqn: "carbonql.BoaviztaCpuImpactModel", version: "1.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hdml6dGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib2F2aXp0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLGlDQUEwQjtBQU9uQixNQUFNLFlBQVksR0FBRyxDQUFDLEdBQVcsRUFBVSxFQUFFLENBQ2hELEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBVSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFEdkQsUUFBQSxZQUFZLGdCQUMyQztBQW9CcEUsTUFBYSxpQkFBaUI7O0FBQTlCLDhDQVdDOzs7QUFFRCxNQUFhLHdCQUF3QjtJQUFyQztRQUdjLG9CQUFlLEdBQVEsU0FBUyxDQUFDO0tBMkM5QztJQXpDRyxlQUFlO1FBQ1gsT0FBTyxvQkFBb0IsQ0FBQTtJQUMvQixDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVksRUFBRSxZQUFnQztRQUNwRCxNQUFNLGVBQWUsR0FBRyxZQUFxQyxDQUFDO1FBQzlELElBQUksZUFBZSxFQUFFLGNBQWMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUM3QyxJQUFJLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUM7U0FDNUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVksRUFBRSxlQUFzQztRQUMvRCxJQUFJLGVBQWUsRUFBRSxjQUFjLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDN0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDO1NBQzVDO1FBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELFlBQVksQ0FBQyxVQUFrQjtRQUMzQixJQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FBQztJQUN0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SUFFTyxjQUFjLENBQUMsUUFBYTtRQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDVixJQUFJLFNBQVMsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQzVCLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQTtZQUN6RCxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDbkQ7YUFBTSxJQUFJLEtBQUssSUFBSSxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ3hELENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQTtZQUM5QyxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDeEM7UUFDRCxPQUFPLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBQyxDQUFDO0lBQ2xCLENBQUM7O0FBbEdMLHdEQW1HQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SUltcGFjdE1vZGVsSW50ZXJmYWNlfSBmcm9tIFwiLi9pbnRlcmZhY2VzL2luZGV4XCI7XG5pbXBvcnQgYXhpb3MgZnJvbSBcImF4aW9zXCI7XG5cbmV4cG9ydCB7XG4gICAgSUltcGFjdE1vZGVsSW50ZXJmYWNlXG59IGZyb20gXCIuL2ludGVyZmFjZXMvaW5kZXhcIjtcblxuXG5leHBvcnQgY29uc3QgY2FtZWxUb1NuYWtlID0gKHN0cjogc3RyaW5nKTogc3RyaW5nID0+XG4gICAgc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgKCQxOiBzdHJpbmcpID0+IGBfJHskMS50b0xvd2VyQ2FzZSgpfWApO1xuXG5leHBvcnQgaW50ZXJmYWNlIElCb2F2aXp0YVN0YXRpY1BhcmFtcyB7XG4gICAgcHJvdmlkZXI/OiBzdHJpbmc7XG4gICAgY29tcG9uZW50VHlwZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQm9hdml6dGFDcHVQYXJhbXMge1xuICAgIGNvcmVVbml0cz86IG51bWJlcjtcbiAgICBkaWVTaXplPzogbnVtYmVyO1xuICAgIGRpZVNpemVQZXJDb3JlPzogbnVtYmVyO1xuICAgIG1hbnVmYWN0dXJlcj86IHN0cmluZztcbiAgICBtb2RlbFJhbmdlPzogc3RyaW5nO1xuICAgIGZhbWlseT86IHN0cmluZztcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHRkcD86IG51bWJlcjtcbiAgICB2ZXJib3NlPzogYm9vbGVhbjtcbiAgICBhbGxvY2F0aW9uPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQm9hdml6dGFDcHVQYXJhbXMgaW1wbGVtZW50cyBJQm9hdml6dGFDcHVQYXJhbXMge1xuICAgIGNvcmVVbml0cz86IG51bWJlcjtcbiAgICBkaWVTaXplPzogbnVtYmVyO1xuICAgIGRpZVNpemVQZXJDb3JlPzogbnVtYmVyO1xuICAgIG1hbnVmYWN0dXJlcj86IHN0cmluZztcbiAgICBtb2RlbFJhbmdlPzogc3RyaW5nO1xuICAgIGZhbWlseT86IHN0cmluZztcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHRkcD86IG51bWJlcjtcbiAgICB2ZXJib3NlPzogYm9vbGVhbjtcbiAgICBhbGxvY2F0aW9uPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQm9hdml6dGFDbG91ZEltcGFjdE1vZGVsIGltcGxlbWVudHMgSUltcGFjdE1vZGVsSW50ZXJmYWNlIHtcbiAgICBwdWJsaWMgcHJvdmlkZXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwdWJsaWMgbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIHByb3RlY3RlZCBhdXRoQ3JlZGVudGlhbHM6IGFueSA9IHVuZGVmaW5lZDtcblxuICAgIG1vZGVsSWRlbnRpZmllcigpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gXCJib2F2aXp0YS5jbG91ZC5zY2lcIlxuICAgIH1cblxuICAgIGNvbmZpZ3VyZShuYW1lOiBzdHJpbmcsIHN0YXRpY1BhcmFtczogb2JqZWN0IHwgdW5kZWZpbmVkKTogSUltcGFjdE1vZGVsSW50ZXJmYWNlIHtcbiAgICAgICAgY29uc3Qgc3RhdGljUGFyYW1DYXN0ID0gc3RhdGljUGFyYW1zIGFzIElCb2F2aXp0YVN0YXRpY1BhcmFtcztcbiAgICAgICAgaWYgKHN0YXRpY1BhcmFtQ2FzdD8uaGFzT3duUHJvcGVydHkoJ3Byb3ZpZGVyJykpIHtcbiAgICAgICAgICAgIHRoaXMucHJvdmlkZXIgPSBzdGF0aWNQYXJhbUNhc3QucHJvdmlkZXI7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgY29uZmlndXJlVHlwZWQobmFtZTogc3RyaW5nLCBzdGF0aWNQYXJhbUNhc3Q6IElCb2F2aXp0YVN0YXRpY1BhcmFtcyk6IElJbXBhY3RNb2RlbEludGVyZmFjZSB7XG4gICAgICAgIGlmIChzdGF0aWNQYXJhbUNhc3Q/Lmhhc093blByb3BlcnR5KCdwcm92aWRlcicpKSB7XG4gICAgICAgICAgICB0aGlzLnByb3ZpZGVyID0gc3RhdGljUGFyYW1DYXN0LnByb3ZpZGVyO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGF1dGhlbnRpY2F0ZShhdXRoUGFyYW1zOiBvYmplY3QpIHtcbiAgICAgICAgdGhpcy5hdXRoQ3JlZGVudGlhbHMgPSBhdXRoUGFyYW1zO1xuICAgIH1cblxuXG4gICAgYXN5bmMgdXNhZ2UoZGF0YTogb2JqZWN0IHwgb2JqZWN0W10pOiBQcm9taXNlPG9iamVjdD4ge1xuICAgICAgICBjb25zdCBkYXRhQ2FzdCA9IGRhdGEgYXMgeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgICAgICAgaWYgKCdwcm92aWRlcicgaW4gZGF0YUNhc3QpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnByb3ZpZGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkYXRhQ2FzdC5wcm92aWRlciA9IHRoaXMucHJvdmlkZXI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTWFsZm9ybWVkIFRlbGVtZXRyeTogTWlzc2luZyBwcm92aWRlcicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICgnaW5zdGFuY2VfdHlwZScgaW4gZGF0YUNhc3QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTWFsZm9ybWVkIFRlbGVtZXRyeTogTWlzc2luZyBpbnN0YW5jZV90eXBlJyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KCdodHRwczovL2FwaS5ib2F2aXp0YS5vcmcvdjEvY2xvdWQvJywgZGF0YUNhc3QpO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUJvYXZpenRhVXNhZ2VTQ0kge1xuICAgIGU6IG51bWJlcjtcbiAgICBtOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBCb2F2aXp0YUNwdUltcGFjdE1vZGVsIGltcGxlbWVudHMgSUltcGFjdE1vZGVsSW50ZXJmYWNlIHtcbiAgICBwcml2YXRlIGNvbXBvbmVudFR5cGUgPSBcImNwdVwiO1xuICAgIHByaXZhdGUgc2hhcmVkUGFyYW1zOiBJQm9hdml6dGFDcHVQYXJhbXMgfCB1bmRlZmluZWQ7XG4gICAgcHVibGljIG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwdWJsaWMgdmVyYm9zZTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHB1YmxpYyBhbGxvY2F0aW9uOiBzdHJpbmcgPSBcIlRPVEFMXCI7XG4gICAgcHJvdGVjdGVkIGF1dGhDcmVkZW50aWFsczogYW55ID0gdW5kZWZpbmVkO1xuXG5cbiAgICBtb2RlbElkZW50aWZpZXIoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIFwiYm9hdml6dGEuY3B1LnNjaVwiXG4gICAgfVxuXG4gICAgYXV0aGVudGljYXRlKGF1dGhQYXJhbXM6IG9iamVjdCkge1xuICAgICAgICB0aGlzLmF1dGhDcmVkZW50aWFscyA9IGF1dGhQYXJhbXM7XG4gICAgfVxuXG4gICAgY29uZmlndXJlKG5hbWU6IHN0cmluZywgc3RhdGljUGFyYW1zOiBvYmplY3QgfCB1bmRlZmluZWQpOiBJSW1wYWN0TW9kZWxJbnRlcmZhY2Uge1xuICAgICAgICBjb25zdCBzdGF0aWNQYXJhbUNhc3QgPSB0aGlzLmNhcHR1cmVTdGF0aWNQYXJhbXMoc3RhdGljUGFyYW1zIGFzIElCb2F2aXp0YUNwdVBhcmFtcylcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5zaGFyZWRQYXJhbXMgPSBzdGF0aWNQYXJhbUNhc3Q7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FwdHVyZVN0YXRpY1BhcmFtcyhzdGF0aWNQYXJhbUNhc3Q6IElCb2F2aXp0YUNwdVBhcmFtcyB8IChJQm9hdml6dGFDcHVQYXJhbXMgJiB7XG4gICAgICAgIHZlcmJvc2U6IHVua25vd25cbiAgICB9KSB8IChJQm9hdml6dGFDcHVQYXJhbXMgJiB7IGFsbG9jYXRpb246IHVua25vd24gfSkpIHtcbiAgICAgICAgaWYgKCd2ZXJib3NlJyBpbiBzdGF0aWNQYXJhbUNhc3QpIHtcbiAgICAgICAgICAgIHRoaXMudmVyYm9zZSA9IHN0YXRpY1BhcmFtQ2FzdC52ZXJib3NlID8/IGZhbHNlO1xuICAgICAgICAgICAgc3RhdGljUGFyYW1DYXN0LnZlcmJvc2UgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCdhbGxvY2F0aW9uJyBpbiBzdGF0aWNQYXJhbUNhc3QpIHtcbiAgICAgICAgICAgIHRoaXMuYWxsb2NhdGlvbiA9IHN0YXRpY1BhcmFtQ2FzdC5hbGxvY2F0aW9uID8/IFwidG90YWxcIjtcbiAgICAgICAgICAgIHN0YXRpY1BhcmFtQ2FzdC5hbGxvY2F0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdGF0aWNQYXJhbUNhc3RcbiAgICB9XG5cbiAgICBjb25maWd1cmVUeXBlZChuYW1lOiBzdHJpbmcsIHN0YXRpY1BhcmFtQ2FzdDogSUJvYXZpenRhQ3B1UGFyYW1zKTogSUltcGFjdE1vZGVsSW50ZXJmYWNlIHtcbiAgICAgICAgc3RhdGljUGFyYW1DYXN0ID0gdGhpcy5jYXB0dXJlU3RhdGljUGFyYW1zKHN0YXRpY1BhcmFtQ2FzdClcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5zaGFyZWRQYXJhbXMgPSBzdGF0aWNQYXJhbUNhc3Q7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFzeW5jIHVzYWdlKGRhdGE6IG9iamVjdCB8IG9iamVjdFtdKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgY29uc3QgdXNhZ2VDYXN0ID0gZGF0YSBhcyB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuICAgICAgICBsZXQgbVRvdGFsID0gMDtcbiAgICAgICAgbGV0IGVUb3RhbCA9IDA7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHVzYWdlQ2FzdCkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VDYXN0KSB7XG4gICAgICAgICAgICAgICAgY29uc3Qge20sIGV9ID0gYXdhaXQgdGhpcy5zaW5nbGVVc2FnZSh1c2FnZSkgYXMgSUJvYXZpenRhVXNhZ2VTQ0k7XG4gICAgICAgICAgICAgICAgbVRvdGFsICs9IG07XG4gICAgICAgICAgICAgICAgZVRvdGFsICs9IGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB7bSwgZX0gPSBhd2FpdCB0aGlzLnNpbmdsZVVzYWdlKHVzYWdlQ2FzdCkgYXMgSUJvYXZpenRhVXNhZ2VTQ0lcbiAgICAgICAgICAgIG1Ub3RhbCArPSBtO1xuICAgICAgICAgICAgZVRvdGFsICs9IGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiZVwiOiBlVG90YWwsXG4gICAgICAgICAgICBcIm1cIjogbVRvdGFsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgc2luZ2xlVXNhZ2UodXNhZ2VDYXN0OiB7IFtwOiBzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8b2JqZWN0PiB7XG4gICAgICAgIGlmICh0aGlzLnNoYXJlZFBhcmFtcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbXByb3BlciBJbml0aWFsaXphdGlvbjogTWlzc2luZyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnNcIilcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkYXRhQ2FzdCA9IHRoaXMubm9ybWFsaXplRGF0YSh0aGlzLnNoYXJlZFBhcmFtcyk7XG4gICAgICAgIGRhdGFDYXN0Wyd1c2FnZSddID0gdXNhZ2VDYXN0XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cHM6Ly9hcGkuYm9hdml6dGEub3JnL3YxL2NvbXBvbmVudC8ke3RoaXMuY29tcG9uZW50VHlwZX0/dmVyYm9zZT0ke3RoaXMudmVyYm9zZX0mYWxsb2NhdGlvbj0ke3RoaXMuYWxsb2NhdGlvbn1gLCBkYXRhQ2FzdCk7XG4gICAgICAgIHJldHVybiB0aGlzLmZvcm1hdFJlc3BvbnNlKHJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG5vcm1hbGl6ZURhdGEoZGF0YVBhcmFtczogb2JqZWN0KTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgICAgIGNvbnN0IGRhdGFDYXN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0gT2JqZWN0LmFzc2lnbihkYXRhUGFyYW1zKTtcbiAgICAgICAgZm9yIChsZXQga2V5IGluIGRhdGFDYXN0KSB7XG4gICAgICAgICAgICBkYXRhQ2FzdFtjYW1lbFRvU25ha2Uoa2V5KV0gPSBkYXRhQ2FzdFtrZXldXG4gICAgICAgICAgICBpZiAoL1tBLVpdLy50ZXN0KGtleSkpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YUNhc3Rba2V5XVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhQ2FzdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdFJlc3BvbnNlKHJlc3BvbnNlOiBhbnkpIHtcbiAgICAgICAgbGV0IG0gPSAwO1xuICAgICAgICBsZXQgZSA9IDA7XG4gICAgICAgIGlmICgnaW1wYWN0cycgaW4gcmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgbSA9IHJlc3BvbnNlLmRhdGFbJ2ltcGFjdHMnXVsnZ3dwJ11bJ21hbnVmYWN0dXJlJ10gKiAxMDAwXG4gICAgICAgICAgICBlID0gcmVzcG9uc2UuZGF0YVsnaW1wYWN0cyddWydwZSddWyd1c2UnXSAvIDMuNjtcbiAgICAgICAgfSBlbHNlIGlmICgnZ3dwJyBpbiByZXNwb25zZS5kYXRhICYmICdwZScgaW4gcmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgbSA9IHJlc3BvbnNlLmRhdGFbJ2d3cCddWydtYW51ZmFjdHVyZSddICogMTAwMFxuICAgICAgICAgICAgZSA9IHJlc3BvbnNlLmRhdGFbJ3BlJ11bJ3VzZSddIC8gMy42O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7bSwgZX07XG4gICAgfVxufVxuIl19