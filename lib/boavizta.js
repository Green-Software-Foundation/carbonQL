"use strict";
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BoaviztaCpuImpactModel = exports.BoaviztaCloudImpactModel = exports.BoaviztaCpuParams = exports.camelToSnake = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const axios_1 = require("axios");
const camelToSnake = (str) => str.replace(/([A-Z])/g, ($1) => `_${$1.toLowerCase()}`);
exports.camelToSnake = camelToSnake;
class BoaviztaCpuParams {
}
exports.BoaviztaCpuParams = BoaviztaCpuParams;
_a = JSII_RTTI_SYMBOL_1;
BoaviztaCpuParams[_a] = { fqn: "carbonql.BoaviztaCpuParams", version: "1.0.0" };
class BoaviztaCloudImpactModel {
    constructor() {
        this.authCredentials = undefined;
    }
    modelIdentifier() {
        return "boavizta.cloud.sci";
    }
    configure(name, staticParams) {
        const staticParamCast = staticParams;
        if (staticParamCast?.hasOwnProperty('provider')) {
            this.provider = staticParamCast.provider;
        }
        this.name = name;
        return this;
    }
    configureTyped(name, staticParamCast) {
        if (staticParamCast?.hasOwnProperty('provider')) {
            this.provider = staticParamCast.provider;
        }
        this.name = name;
        return this;
    }
    authenticate(authParams) {
        this.authCredentials = authParams;
    }
    async usage(data) {
        const dataCast = data;
        if ('provider' in dataCast) {
            if (this.provider !== undefined) {
                dataCast.provider = this.provider;
            }
            else {
                throw new Error('Malformed Telemetry: Missing provider');
            }
        }
        if ('instance_type' in dataCast) {
            throw new Error('Malformed Telemetry: Missing instance_type');
        }
        const response = await axios_1.default.post('https://api.boavizta.org/v1/cloud/', dataCast);
        return response.data;
    }
}
exports.BoaviztaCloudImpactModel = BoaviztaCloudImpactModel;
_b = JSII_RTTI_SYMBOL_1;
BoaviztaCloudImpactModel[_b] = { fqn: "carbonql.BoaviztaCloudImpactModel", version: "1.0.0" };
class BoaviztaCpuImpactModel {
    constructor() {
        this.componentType = "cpu";
        this.verbose = false;
        this.allocation = "TOTAL";
        this.authCredentials = undefined;
    }
    modelIdentifier() {
        return "boavizta.cpu.sci";
    }
    authenticate(authParams) {
        this.authCredentials = authParams;
    }
    configure(name, staticParams) {
        const staticParamCast = staticParams;
        if ('verbose' in staticParamCast) {
            this.verbose = staticParamCast.verbose ?? false;
            staticParamCast.verbose = undefined;
        }
        if ('allocation' in staticParamCast) {
            this.allocation = staticParamCast.allocation ?? "total";
            staticParamCast.allocation = undefined;
        }
        this.name = name;
        this.sharedParams = staticParamCast;
        return this;
    }
    configureTyped(name, staticParamCast) {
        if ('verbose' in staticParamCast) {
            this.verbose = staticParamCast.verbose ?? false;
            staticParamCast.verbose = undefined;
        }
        if ('allocation' in staticParamCast) {
            this.allocation = staticParamCast.allocation ?? "total";
            staticParamCast.allocation = undefined;
        }
        this.name = name;
        this.sharedParams = staticParamCast;
        return this;
    }
    async usage(data) {
        const usageCast = data;
        let mTotal = 0;
        let eTotal = 0;
        if (Array.isArray(usageCast)) {
            for (const usage of usageCast) {
                const { m, e } = await this.singleUsage(usage);
                mTotal += m;
                eTotal += e;
            }
        }
        else {
            const { m, e } = await this.singleUsage(usageCast);
            mTotal += m;
            eTotal += e;
        }
        return {
            "e": eTotal,
            "m": mTotal
        };
    }
    async singleUsage(usageCast) {
        if (this.sharedParams === undefined) {
            throw new Error("Improper Initialization: Missing configuration parameters");
        }
        const dataCast = Object.assign(this.sharedParams);
        for (let key in dataCast) {
            dataCast[(0, exports.camelToSnake)(key)] = dataCast[key];
            if (/[A-Z]/.test(key)) {
                delete dataCast[key];
            }
        }
        dataCast['usage'] = usageCast;
        console.log(dataCast);
        const response = await axios_1.default.post(`https://api.boavizta.org/v1/component/${this.componentType}?verbose=${this.verbose}&allocation=${this.allocation}`, dataCast);
        console.log(response.data);
        let m = 0;
        let e = 0;
        if ('impacts' in response.data) {
            m = response.data['impacts']['gwp']['manufacture'] * 1000;
            e = response.data['impacts']['pe']['use'] / 3.6;
        }
        else if ('gwp' in response.data && 'pe' in response.data) {
            m = response.data['gwp']['manufacture'] * 1000;
            e = response.data['pe']['use'] / 3.6;
        }
        return {
            "e": e,
            "m": m
        };
    }
}
exports.BoaviztaCpuImpactModel = BoaviztaCpuImpactModel;
_c = JSII_RTTI_SYMBOL_1;
BoaviztaCpuImpactModel[_c] = { fqn: "carbonql.BoaviztaCpuImpactModel", version: "1.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hdml6dGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib2F2aXp0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLGlDQUEwQjtBQU9uQixNQUFNLFlBQVksR0FBRyxDQUFDLEdBQVcsRUFBVSxFQUFFLENBQ2hELEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBVSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFEdkQsUUFBQSxZQUFZLGdCQUMyQztBQW9CcEUsTUFBYSxpQkFBaUI7O0FBQTlCLDhDQVdDOzs7QUFFRCxNQUFhLHdCQUF3QjtJQUFyQztRQUdjLG9CQUFlLEdBQVEsU0FBUyxDQUFDO0tBMkM5QztJQXpDRyxlQUFlO1FBQ1gsT0FBTyxvQkFBb0IsQ0FBQTtJQUMvQixDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVksRUFBRSxZQUFnQztRQUNwRCxNQUFNLGVBQWUsR0FBRyxZQUFxQyxDQUFDO1FBQzlELElBQUksZUFBZSxFQUFFLGNBQWMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUM3QyxJQUFJLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUM7U0FDNUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVksRUFBRSxlQUFzQztRQUMvRCxJQUFJLGVBQWUsRUFBRSxjQUFjLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDN0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDO1NBQzVDO1FBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELFlBQVksQ0FBQyxVQUFrQjtRQUMzQixJQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FBQztJQUN0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SyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDVixJQUFJLFNBQVMsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQzVCLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQTtZQUN6RCxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDbkQ7YUFBTSxJQUFJLEtBQUssSUFBSSxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ3hELENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQTtZQUM5QyxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDeEM7UUFDRCxPQUFPO1lBQ0gsR0FBRyxFQUFFLENBQUM7WUFDTixHQUFHLEVBQUUsQ0FBQztTQUNULENBQUM7SUFDTixDQUFDOztBQS9GTCx3REFnR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0lJbXBhY3RNb2RlbEludGVyZmFjZX0gZnJvbSBcIi4vaW50ZXJmYWNlcy9pbmRleFwiO1xuaW1wb3J0IGF4aW9zIGZyb20gXCJheGlvc1wiO1xuXG5leHBvcnQge1xuICAgIElJbXBhY3RNb2RlbEludGVyZmFjZVxufSBmcm9tIFwiLi9pbnRlcmZhY2VzL2luZGV4XCI7XG5cblxuZXhwb3J0IGNvbnN0IGNhbWVsVG9TbmFrZSA9IChzdHI6IHN0cmluZyk6IHN0cmluZyA9PlxuICAgIHN0ci5yZXBsYWNlKC8oW0EtWl0pL2csICgkMTogc3RyaW5nKSA9PiBgXyR7JDEudG9Mb3dlckNhc2UoKX1gKTtcblxuZXhwb3J0IGludGVyZmFjZSBJQm9hdml6dGFTdGF0aWNQYXJhbXMge1xuICAgIHByb3ZpZGVyPzogc3RyaW5nO1xuICAgIGNvbXBvbmVudFR5cGU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUJvYXZpenRhQ3B1UGFyYW1zIHtcbiAgICBjb3JlVW5pdHM/OiBudW1iZXI7XG4gICAgZGllU2l6ZT86IG51bWJlcjtcbiAgICBkaWVTaXplUGVyQ29yZT86IG51bWJlcjtcbiAgICBtYW51ZmFjdHVyZXI/OiBzdHJpbmc7XG4gICAgbW9kZWxSYW5nZT86IHN0cmluZztcbiAgICBmYW1pbHk/OiBzdHJpbmc7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0ZHA/OiBudW1iZXI7XG4gICAgdmVyYm9zZT86IGJvb2xlYW47XG4gICAgYWxsb2NhdGlvbj86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEJvYXZpenRhQ3B1UGFyYW1zIGltcGxlbWVudHMgSUJvYXZpenRhQ3B1UGFyYW1zIHtcbiAgICBjb3JlVW5pdHM/OiBudW1iZXI7XG4gICAgZGllU2l6ZT86IG51bWJlcjtcbiAgICBkaWVTaXplUGVyQ29yZT86IG51bWJlcjtcbiAgICBtYW51ZmFjdHVyZXI/OiBzdHJpbmc7XG4gICAgbW9kZWxSYW5nZT86IHN0cmluZztcbiAgICBmYW1pbHk/OiBzdHJpbmc7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0ZHA/OiBudW1iZXI7XG4gICAgdmVyYm9zZT86IGJvb2xlYW47XG4gICAgYWxsb2NhdGlvbj86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEJvYXZpenRhQ2xvdWRJbXBhY3RNb2RlbCBpbXBsZW1lbnRzIElJbXBhY3RNb2RlbEludGVyZmFjZSB7XG4gICAgcHVibGljIHByb3ZpZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgcHVibGljIG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBwcm90ZWN0ZWQgYXV0aENyZWRlbnRpYWxzOiBhbnkgPSB1bmRlZmluZWQ7XG5cbiAgICBtb2RlbElkZW50aWZpZXIoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIFwiYm9hdml6dGEuY2xvdWQuc2NpXCJcbiAgICB9XG5cbiAgICBjb25maWd1cmUobmFtZTogc3RyaW5nLCBzdGF0aWNQYXJhbXM6IG9iamVjdCB8IHVuZGVmaW5lZCk6IElJbXBhY3RNb2RlbEludGVyZmFjZSB7XG4gICAgICAgIGNvbnN0IHN0YXRpY1BhcmFtQ2FzdCA9IHN0YXRpY1BhcmFtcyBhcyBJQm9hdml6dGFTdGF0aWNQYXJhbXM7XG4gICAgICAgIGlmIChzdGF0aWNQYXJhbUNhc3Q/Lmhhc093blByb3BlcnR5KCdwcm92aWRlcicpKSB7XG4gICAgICAgICAgICB0aGlzLnByb3ZpZGVyID0gc3RhdGljUGFyYW1DYXN0LnByb3ZpZGVyO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbmZpZ3VyZVR5cGVkKG5hbWU6IHN0cmluZywgc3RhdGljUGFyYW1DYXN0OiBJQm9hdml6dGFTdGF0aWNQYXJhbXMpOiBJSW1wYWN0TW9kZWxJbnRlcmZhY2Uge1xuICAgICAgICBpZiAoc3RhdGljUGFyYW1DYXN0Py5oYXNPd25Qcm9wZXJ0eSgncHJvdmlkZXInKSkge1xuICAgICAgICAgICAgdGhpcy5wcm92aWRlciA9IHN0YXRpY1BhcmFtQ2FzdC5wcm92aWRlcjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhdXRoZW50aWNhdGUoYXV0aFBhcmFtczogb2JqZWN0KSB7XG4gICAgICAgIHRoaXMuYXV0aENyZWRlbnRpYWxzID0gYXV0aFBhcmFtcztcbiAgICB9XG5cblxuICAgIGFzeW5jIHVzYWdlKGRhdGE6IG9iamVjdCB8IG9iamVjdFtdKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgY29uc3QgZGF0YUNhc3QgPSBkYXRhIGFzIHsgW2tleTogc3RyaW5nXTogYW55IH07XG4gICAgICAgIGlmICgncHJvdmlkZXInIGluIGRhdGFDYXN0KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wcm92aWRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgZGF0YUNhc3QucHJvdmlkZXIgPSB0aGlzLnByb3ZpZGVyO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01hbGZvcm1lZCBUZWxlbWV0cnk6IE1pc3NpbmcgcHJvdmlkZXInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoJ2luc3RhbmNlX3R5cGUnIGluIGRhdGFDYXN0KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01hbGZvcm1lZCBUZWxlbWV0cnk6IE1pc3NpbmcgaW5zdGFuY2VfdHlwZScpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdCgnaHR0cHM6Ly9hcGkuYm9hdml6dGEub3JnL3YxL2Nsb3VkLycsIGRhdGFDYXN0KTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElCb2F2aXp0YVVzYWdlU0NJIHtcbiAgICBlOiBudW1iZXI7XG4gICAgbTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQm9hdml6dGFDcHVJbXBhY3RNb2RlbCBpbXBsZW1lbnRzIElJbXBhY3RNb2RlbEludGVyZmFjZSB7XG4gICAgcHJpdmF0ZSBjb21wb25lbnRUeXBlID0gXCJjcHVcIjtcbiAgICBwcml2YXRlIHNoYXJlZFBhcmFtczogSUJvYXZpenRhQ3B1UGFyYW1zIHwgdW5kZWZpbmVkO1xuICAgIHB1YmxpYyBuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgcHVibGljIHZlcmJvc2U6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwdWJsaWMgYWxsb2NhdGlvbjogc3RyaW5nID0gXCJUT1RBTFwiO1xuICAgIHByb3RlY3RlZCBhdXRoQ3JlZGVudGlhbHM6IGFueSA9IHVuZGVmaW5lZDtcblxuXG4gICAgbW9kZWxJZGVudGlmaWVyKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBcImJvYXZpenRhLmNwdS5zY2lcIlxuICAgIH1cblxuICAgIGF1dGhlbnRpY2F0ZShhdXRoUGFyYW1zOiBvYmplY3QpIHtcbiAgICAgICAgdGhpcy5hdXRoQ3JlZGVudGlhbHMgPSBhdXRoUGFyYW1zO1xuICAgIH1cblxuICAgIGNvbmZpZ3VyZShuYW1lOiBzdHJpbmcsIHN0YXRpY1BhcmFtczogb2JqZWN0IHwgdW5kZWZpbmVkKTogSUltcGFjdE1vZGVsSW50ZXJmYWNlIHtcbiAgICAgICAgY29uc3Qgc3RhdGljUGFyYW1DYXN0ID0gc3RhdGljUGFyYW1zIGFzIElCb2F2aXp0YUNwdVBhcmFtc1xuICAgICAgICBpZiAoJ3ZlcmJvc2UnIGluIHN0YXRpY1BhcmFtQ2FzdCkge1xuICAgICAgICAgICAgdGhpcy52ZXJib3NlID0gc3RhdGljUGFyYW1DYXN0LnZlcmJvc2UgPz8gZmFsc2U7XG4gICAgICAgICAgICBzdGF0aWNQYXJhbUNhc3QudmVyYm9zZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoJ2FsbG9jYXRpb24nIGluIHN0YXRpY1BhcmFtQ2FzdCkge1xuICAgICAgICAgICAgdGhpcy5hbGxvY2F0aW9uID0gc3RhdGljUGFyYW1DYXN0LmFsbG9jYXRpb24gPz8gXCJ0b3RhbFwiO1xuICAgICAgICAgICAgc3RhdGljUGFyYW1DYXN0LmFsbG9jYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5zaGFyZWRQYXJhbXMgPSBzdGF0aWNQYXJhbUNhc3Q7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbmZpZ3VyZVR5cGVkKG5hbWU6IHN0cmluZywgc3RhdGljUGFyYW1DYXN0OiBJQm9hdml6dGFDcHVQYXJhbXMpOiBJSW1wYWN0TW9kZWxJbnRlcmZhY2Uge1xuICAgICAgICBpZiAoJ3ZlcmJvc2UnIGluIHN0YXRpY1BhcmFtQ2FzdCkge1xuICAgICAgICAgICAgdGhpcy52ZXJib3NlID0gc3RhdGljUGFyYW1DYXN0LnZlcmJvc2UgPz8gZmFsc2U7XG4gICAgICAgICAgICBzdGF0aWNQYXJhbUNhc3QudmVyYm9zZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoJ2FsbG9jYXRpb24nIGluIHN0YXRpY1BhcmFtQ2FzdCkge1xuICAgICAgICAgICAgdGhpcy5hbGxvY2F0aW9uID0gc3RhdGljUGFyYW1DYXN0LmFsbG9jYXRpb24gPz8gXCJ0b3RhbFwiO1xuICAgICAgICAgICAgc3RhdGljUGFyYW1DYXN0LmFsbG9jYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5zaGFyZWRQYXJhbXMgPSBzdGF0aWNQYXJhbUNhc3Q7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFzeW5jIHVzYWdlKGRhdGE6IG9iamVjdCB8IG9iamVjdFtdKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgY29uc3QgdXNhZ2VDYXN0ID0gZGF0YSBhcyB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuICAgICAgICBsZXQgbVRvdGFsID0gMDtcbiAgICAgICAgbGV0IGVUb3RhbCA9IDA7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHVzYWdlQ2FzdCkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdXNhZ2Ugb2YgdXNhZ2VDYXN0KSB7XG4gICAgICAgICAgICAgICAgY29uc3Qge20sIGV9ID0gYXdhaXQgdGhpcy5zaW5nbGVVc2FnZSh1c2FnZSkgYXMgSUJvYXZpenRhVXNhZ2VTQ0k7XG4gICAgICAgICAgICAgICAgbVRvdGFsICs9IG07XG4gICAgICAgICAgICAgICAgZVRvdGFsICs9IGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB7bSwgZX0gPSBhd2FpdCB0aGlzLnNpbmdsZVVzYWdlKHVzYWdlQ2FzdCkgYXMgSUJvYXZpenRhVXNhZ2VTQ0lcbiAgICAgICAgICAgIG1Ub3RhbCArPSBtO1xuICAgICAgICAgICAgZVRvdGFsICs9IGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiZVwiOiBlVG90YWwsXG4gICAgICAgICAgICBcIm1cIjogbVRvdGFsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgc2luZ2xlVXNhZ2UodXNhZ2VDYXN0OiB7IFtwOiBzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8b2JqZWN0PiB7XG4gICAgICAgIGlmICh0aGlzLnNoYXJlZFBhcmFtcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbXByb3BlciBJbml0aWFsaXphdGlvbjogTWlzc2luZyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnNcIilcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkYXRhQ2FzdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IE9iamVjdC5hc3NpZ24odGhpcy5zaGFyZWRQYXJhbXMpO1xuICAgICAgICBmb3IgKGxldCBrZXkgaW4gZGF0YUNhc3QpIHtcbiAgICAgICAgICAgIGRhdGFDYXN0W2NhbWVsVG9TbmFrZShrZXkpXSA9IGRhdGFDYXN0W2tleV1cbiAgICAgICAgICAgIGlmICgvW0EtWl0vLnRlc3Qoa2V5KSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhQ2FzdFtrZXldXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZGF0YUNhc3RbJ3VzYWdlJ10gPSB1c2FnZUNhc3RcbiAgICAgICAgY29uc29sZS5sb2coZGF0YUNhc3QpO1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHBzOi8vYXBpLmJvYXZpenRhLm9yZy92MS9jb21wb25lbnQvJHt0aGlzLmNvbXBvbmVudFR5cGV9P3ZlcmJvc2U9JHt0aGlzLnZlcmJvc2V9JmFsbG9jYXRpb249JHt0aGlzLmFsbG9jYXRpb259YCwgZGF0YUNhc3QpO1xuICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTtcbiAgICAgICAgbGV0IG0gPSAwO1xuICAgICAgICBsZXQgZSA9IDA7XG4gICAgICAgIGlmICgnaW1wYWN0cycgaW4gcmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgbSA9IHJlc3BvbnNlLmRhdGFbJ2ltcGFjdHMnXVsnZ3dwJ11bJ21hbnVmYWN0dXJlJ10gKiAxMDAwXG4gICAgICAgICAgICBlID0gcmVzcG9uc2UuZGF0YVsnaW1wYWN0cyddWydwZSddWyd1c2UnXSAvIDMuNjtcbiAgICAgICAgfSBlbHNlIGlmICgnZ3dwJyBpbiByZXNwb25zZS5kYXRhICYmICdwZScgaW4gcmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgbSA9IHJlc3BvbnNlLmRhdGFbJ2d3cCddWydtYW51ZmFjdHVyZSddICogMTAwMFxuICAgICAgICAgICAgZSA9IHJlc3BvbnNlLmRhdGFbJ3BlJ11bJ3VzZSddIC8gMy42O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBcImVcIjogZSxcbiAgICAgICAgICAgIFwibVwiOiBtXG4gICAgICAgIH07XG4gICAgfVxufVxuIl19